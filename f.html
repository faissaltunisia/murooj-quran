<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ Ø§Ù„Ø±ÙÙ‘Ù‚Ù…ÙÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #041a11; --gold: #c4a04d; --gold-light: #e6cc8a; --white: #fdfaf1; --success: #2ecc71; --error: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); font-family: 'Tajawal', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .official-bar { background: #000; color: var(--gold); text-align: center; padding: 8px; font-size: 11px; font-weight: bold; border-bottom: 2px solid var(--gold); z-index: 1001; }
        .main-header { background: linear-gradient(135deg, #0b422a 0%, #041a11 100%); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); background: #fff; }
        
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background: #062b1b; border-left: 2px solid var(--gold); overflow-y: auto; padding: 15px; }
        .content { flex: 1; overflow-y: auto; background: var(--white); padding: 20px; padding-bottom: 100px; }

        /* Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© */
        .sem-toggle { display: flex; background: #ddd; border-radius: 50px; margin-bottom: 20px; padding: 5px; }
        .sem-toggle button { flex: 1; padding: 10px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .sem-toggle button.active { background: var(--bg); color: var(--gold); }

        /* Ø§Ù„ØªØ­Ø¯ÙŠ */
        .daily-challenge { background: #000; border: 2px solid var(--gold); border-radius: 15px; padding: 15px; margin-bottom: 20px; color: #fff; display: flex; align-items: center; justify-content: space-between; }
        
        .surah-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .surah-item { position: relative; background: #fff; border: 2px solid var(--gold); border-radius: 12px; padding: 20px 10px; text-align: center; cursor: pointer; }
        .surah-item.done { border-color: var(--success); background: #f0fff4; }

        /* Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 4000; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .video-container { width: 90%; max-width: 700px; position: relative; }
        video { width: 100%; border: 3px solid var(--gold); border-radius: 10px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
        .v-progress-wrap { width: 100%; background: #222; margin-top: 10px; border-radius: 5px; padding: 10px; }
        .v-bar { height: 8px; background: #444; border-radius: 4px; overflow: hidden; }
        #v-fill { height: 100%; background: var(--gold); width: 0%; }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ */
        #alert-msg { color: var(--error); font-weight: bold; margin-top: 10px; display: none; text-align: center; }

        @media (max-width: 992px) { .sidebar { display: none; } }
    </style>
</head>
<body>

    <div class="official-bar">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ÙˆØ¬ | Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ Ø§Ù„Ø±ÙÙ‘Ù‚Ù…ÙÙŠ</div>

    <header class="main-header">
        <img src="https://raw.githubusercontent.com/faissaltunisia/student-grades/main/Screenshot%202025-12-16%20235912.png" class="logo-img">
        <h1 style="color:var(--gold); font-family:'Amiri';">Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬</h1>
    </header>

    <div class="main-layout">
        <aside class="sidebar" id="p-nav"></aside>
        <main class="content">
            <div class="sem-toggle">
                <button id="sem1" class="active" onclick="changeSem(1)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</button>
                <button id="sem2" onclick="changeSem(2)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
            </div>

            <div class="daily-challenge" id="challenge-box">
                <div>
                    <small>â­ ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…</small>
                    <p id="ch-name">Ø³ÙˆØ±Ø© Ø§Ù„ÙŠÙˆÙ…</p>
                </div>
                <button onclick="startChallenge()" id="ch-btn" style="background:var(--gold); padding:8px 15px; border-radius:50px; font-weight:bold;">Ø§Ø¨Ø¯Ø£</button>
                <div id="ch-won" style="display:none;">ğŸ† Ø¨Ø·Ù„ Ø§Ù„ØªØ­Ø¯ÙŠ</div>
            </div>

            <div id="grid" class="surah-grid"></div>
        </main>
    </div>

    <div class="overlay" id="player-layer">
        <div class="video-container">
            <video id="v-player" oncontextmenu="return false;" controlsList="nodownload"></video>
            <div id="alert-msg">âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¹Ø¯Ù… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆØŒ Ø§Ø³ØªÙ…Ø¹ Ø¨Ø®Ø´ÙˆØ¹ Ù„ØªÙƒØ³Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠ!</div>
            <div class="v-progress-wrap">
                <div class="v-bar"><div id="v-fill"></div></div>
                <div style="display:flex; justify-content:space-between; color:#fff; font-size:12px; margin-top:5px;">
                    <span id="v-cur">00:00</span>
                    <span id="v-total">00:00</span>
                </div>
            </div>
            <button onclick="closeVideo()" style="width:100%; margin-top:15px; padding:10px; background:var(--gold); border-radius:5px; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        const SB_URL = 'https://vchzkeebmjqiohgoknnm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjaHprZWVibWpxaW9oZ29rbm5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzU3MjgsImV4cCI6MjA4MTcxMTcyOH0.bDIOdzhpj5M_5Hx7_SdnaBulImmFG41OKIOQGnx7FHI';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let list = [], grade = "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", sem = 1, currentSId = null, isCh = false;
        let completed = JSON.parse(localStorage.getItem('completed_surahs')) || [];
        let maxTimeReached = 0; // Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØºØ´

        async function init() {
            const { data } = await _sb.from('surahs').select('*');
            list = data || [];
            renderSidebar();
            renderGrid();
            setupChallenge();
        }

        function setupChallenge() {
            const index = new Date().getDate() % list.length;
            const challenge = list[index];
            document.getElementById('ch-name').innerText = challenge.title;
            if(localStorage.getItem('ch_'+new Date().toDateString())) {
                document.getElementById('ch-btn').style.display='none';
                document.getElementById('ch-won').style.display='block';
            }
        }

        function startChallenge() {
            const index = new Date().getDate() % list.length;
            playVideo(list[index].video_path, list[index].id, true);
        }

        function playVideo(path, id, challenge = false) {
            currentSId = id; isCh = challenge; maxTimeReached = 0;
            const v = document.getElementById('v-player');
            const layer = document.getElementById('player-layer');
            const url = path.includes('http') ? path : `https://ict.moe.gov.om/tlawti/video/${path}`;
            
            v.src = url;
            layer.style.display = 'flex';
            v.play();

            // Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© ÙˆÙ…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
            v.ontimeupdate = () => {
                // Ø¥Ø°Ø§ Ø­Ø§ÙˆÙ„ Ø§Ù„Ø·Ø§Ù„Ø¨ ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø£Ù…Ø§Ù… Ø£ÙƒØ«Ø± Ù…Ù† Ø«Ø§Ù†ÙŠØªÙŠÙ† Ø¹Ù† Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© ÙˆØµÙ„ Ù„Ù‡Ø§
                if (v.currentTime > maxTimeReached + 2) {
                    v.currentTime = maxTimeReached;
                    document.getElementById('alert-msg').style.display = 'block';
                    setTimeout(() => document.getElementById('alert-msg').style.display = 'none', 3000);
                } else {
                    maxTimeReached = Math.max(maxTimeReached, v.currentTime);
                }

                // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                const pct = (v.currentTime / v.duration) * 100;
                document.getElementById('v-fill').style.width = pct + "%";
                document.getElementById('v-cur').innerText = formatTime(v.currentTime);
                document.getElementById('v-total').innerText = formatTime(v.duration);

                // Ø´Ø±Ø· Ø§Ù„Ù€ 75% Ù„Ù„Ø¥ÙƒÙ…Ø§Ù„
                if (pct >= 75) {
                    markAsDone(id, isCh);
                }
            };
        }

        function markAsDone(id, challenge) {
            if (!completed.includes(id)) {
                completed.push(id);
                localStorage.setItem('completed_surahs', JSON.stringify(completed));
                renderGrid();
            }
            if (challenge) {
                localStorage.setItem('ch_' + new Date().toDateString(), 'true');
                document.getElementById('ch-btn').style.display='none';
                document.getElementById('ch-won').style.display='block';
            }
        }

        function changeSem(s) {
            sem = s;
            document.getElementById('sem1').className = s===1?'active':'';
            document.getElementById('sem2').className = s===2?'active':'';
            renderGrid();
        }

        function renderSidebar() {
            const nav = document.getElementById('p-nav');
            const grades = ["Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†", "Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±"];
            nav.innerHTML = grades.map(g => `<div onclick="grade='${g}';renderGrid()" style="color:#fff; padding:10px; cursor:pointer; border-bottom:1px solid #1a4a35;">${g}</div>`).join('');
        }

        function renderGrid() {
            const g = document.getElementById('grid');
            const filtered = list.filter(i => i.grade === grade && i.semester == sem);
            g.innerHTML = filtered.map(i => `
                <div class="surah-item ${completed.includes(i.id)?'done':''}" onclick="playVideo('${i.video_path}', '${i.id}')">
                    ${completed.includes(i.id)?'âœ…':''} ${i.title}
                </div>
            `).join('');
        }

        function formatTime(s) {
            let min = Math.floor(s/60), sec = Math.floor(s%60);
            return (min<10?'0':'')+min+':'+(sec<10?'0':'')+sec;
        }

        function closeVideo() {
            const v = document.getElementById('v-player');
            v.pause(); v.src = "";
            document.getElementById('player-layer').style.display = 'none';
        }

        init();
    </script>
</body>
</html>
