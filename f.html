<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ V2</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #041a11; --sidebar: #062b1b; --accent: #c4a04d; --gold: #f1c40f; 
            --bg: #f9f7f2; --white: #ffffff; --glass: rgba(255,255,255,0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--primary); font-family: 'Tajawal', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Header Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */
        .main-header { 
            background: rgba(4, 26, 17, 0.95); backdrop-filter: blur(10px);
            padding: 10px 20px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--accent); z-index: 1000;
        }

        .app-container { display: flex; flex: 1; overflow: hidden; }

        /*Sidebar Ù…ØªØ·ÙˆØ± */
        .sidebar { 
            width: 260px; background: var(--sidebar); border-left: 1px solid rgba(196,160,77,0.3);
            display: flex; flex-direction: column; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn-definition {
            background: linear-gradient(45deg, var(--accent), #e6cc8a);
            color: var(--primary); padding: 20px; text-align: center; cursor: pointer;
            font-weight: 900; border: none; font-size: 1.1rem; clip-path: polygon(0 0, 100% 0, 100% 85%, 0 100%);
        }

        .sidebar-menu { flex: 1; overflow-y: auto; padding-top: 10px; }
        .grade-link {
            padding: 16px 20px; color: rgba(255,255,255,0.7); cursor: pointer;
            transition: 0.3s; border-right: 4px solid transparent; display: flex; align-items: center; gap: 10px;
        }
        .grade-link:hover { background: rgba(196,160,77,0.1); color: #fff; }
        .grade-link.active { background: rgba(196,160,77,0.15); color: var(--accent); border-right-color: var(--accent); font-weight: bold; }

        /* Content Area */
        .main-content { flex: 1; overflow-y: auto; background: var(--bg); padding: 25px; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø°ÙƒÙŠ */
        .card-challenge {
            background: #fff; border-radius: 20px; padding: 20px; margin-bottom: 25px;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid rgba(196,160,77,0.2);
            position: relative; overflow: hidden;
        }
        .card-challenge::before { content: ""; position: absolute; top:0; right:0; width:5px; height:100%; background: var(--accent); }

        .btn-play-ch {
            background: var(--primary); color: var(--accent); border: none; padding: 12px 30px;
            border-radius: 50px; font-weight: 900; cursor: pointer; transition: 0.3s;
        }
        .btn-play-ch:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

        /* Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© Ø¨Ù„Ù…Ø³Ø© Neumorphism */
        .semester-nav { 
            display: flex; background: #eee; border-radius: 15px; padding: 5px; 
            max-width: 400px; margin: 0 auto 30px; gap: 5px;
        }
        .sem-tab { 
            flex: 1; padding: 12px; border: none; border-radius: 12px; 
            font-weight: bold; cursor: pointer; transition: 0.3s; color: #777;
        }
        .sem-tab.active { background: var(--white); color: var(--primary); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† */
        .surah-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .surah-item {
            background: var(--white); padding: 25px 15px; border-radius: 18px; text-align: center;
            border: 1px solid #eee; transition: 0.3s; cursor: pointer; font-weight: bold;
        }
        .surah-item:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }

        /* Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø­Ø¯ÙŠØ« */
        .player-modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.98);
            display: none; align-items: center; justify-content: center; z-index: 10000;
        }
        .player-container { width: 95%; max-width: 800px; text-align: center; }
        video { width: 100%; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ Ø£Ùˆ Ø§Ù„Ø®Ø·ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ± */
        .ch-progress-wrap { margin-top: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 15px; display: none; }
        .bar-outer { height: 8px; background: #333; border-radius: 10px; overflow: hidden; margin: 10px 0; }
        .bar-inner { height: 100%; background: linear-gradient(90deg, var(--accent), var(--gold)); width: 0%; transition: 0.4s; }

        /* Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .toast-msg {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--danger); color: #fff; padding: 12px 25px; border-radius: 50px;
            font-weight: bold; display: none; z-index: 10001;
        }

        @media (max-width: 768px) {
            .sidebar { width: 80px; }
            .grade-link span { display: none; }
            .btn-definition { font-size: 0.7rem; padding: 15px 5px; }
        }
    </style>
</head>
<body>

    <header class="main-header">
        <div style="display:flex; align-items:center; gap:12px;">
            <img src="https://raw.githubusercontent.com/faissaltunisia/student-grades/main/Screenshot%202025-12-16%20235912.png" style="width:40px; border-radius:50%; border:1px solid var(--accent);">
            <div style="color:var(--accent); font-weight:900; line-height:1">
                <p style="font-size:0.8rem">Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ÙˆØ¬</p>
                <p style="font-size:0.6rem; opacity:0.7">Ø¹ÙÙ…Ø§Ù† - Ø¸ÙØ§Ø±</p>
            </div>
        </div>
        <h1 style="font-family:'Amiri'; color:var(--accent); font-size:1.6rem;">Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬</h1>
        <div style="width:40px"></div>
    </header>

    <div class="app-container">
        <aside class="sidebar">
            <div class="btn-definition" onclick="showAbout()">Û ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†ØµØ©</div>
            <div class="sidebar-menu" id="grades-list"></div>
        </aside>

        <main class="main-content">
            <div class="card-challenge">
                <div>
                    <h4 style="color:#888; font-size:0.8rem; margin-bottom:5px;">ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø°ÙƒÙŠ âš¡</h4>
                    <h2 id="ch-title" style="color:var(--primary); font-family:'Amiri';">Ø³ÙˆØ±Ø© ...</h2>
                </div>
                <div id="ch-action-area">
                    <button class="btn-play-ch" onclick="startChallenge()">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
                </div>
            </div>

            <div class="semester-nav">
                <button class="sem-tab active" id="s1" onclick="switchSem(1)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</button>
                <button class="sem-tab" id="s2" onclick="switchSem(2)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
            </div>

            <div class="surah-grid" id="surah-grid"></div>
        </main>
    </div>

    <div class="player-modal" id="player-modal">
        <div class="player-container">
            <video id="v-obj" playsinline></video>
            
            <div id="ch-hud" class="ch-progress-wrap">
                <div style="display:flex; justify-content:space-between; color:var(--gold); font-weight:bold; font-size:0.9rem;">
                    <span id="pct-label">0%</span>
                    <span>Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ±ÙƒÙŠØ² ÙˆØ§Ù„Ø¥Ù†Ø¬Ø§Ø²</span>
                </div>
                <div class="bar-outer"><div class="bar-inner" id="bar-inner"></div></div>
                <p style="color:rgba(255,255,255,0.5); font-size:0.7rem;">ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù„Ø¶Ù…Ø§Ù† Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø·</p>
            </div>

            <button onclick="closePlayer()" style="margin-top:25px; background:var(--accent); border:none; padding:12px 50px; border-radius:10px; font-weight:900; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´ØºÙ„</button>
        </div>
    </div>

    <div id="toast" class="toast-msg">âš ï¸ Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ!</div>

    <script>
        const SB_URL = 'https://vchzkeebmjqiohgoknnm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjaHprZWVibWpxaW9oZ29rbm5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzU3MjgsImV4cCI6MjA4MTcxMTcyOH0.bDIOdzhpj5M_5Hx7_SdnaBulImmFG41OKIOQGnx7FHI';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let allSurahs = [], currentGrade = "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", currentSem = 1, isChallenge = false, lastTime = 0;

        async function boot() {
            const { data } = await _sb.from('surahs').select('*');
            allSurahs = data || [];
            renderSidebar();
            refreshUI();
            checkDailyStatus();
        }

        function renderSidebar() {
            const gs = ["Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†", "Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±"];
            document.getElementById('grades-list').innerHTML = gs.map(g => `
                <div class="grade-link ${g===currentGrade?'active':''}" onclick="changeGrade('${g}')">
                    <span style="font-size:1.2rem">ğŸ“–</span>
                    <span>${g}</span>
                </div>
            `).join('');
        }

        function changeGrade(g) { currentGrade = g; renderSidebar(); refreshUI(); }
        function switchSem(s) { 
            currentSem = s; 
            document.getElementById('s1').classList.toggle('active', s===1);
            document.getElementById('s2').classList.toggle('active', s===2);
            refreshUI(); 
        }

        function refreshUI() {
            const list = allSurahs.filter(s => s.grade === currentGrade && s.semester == currentSem);
            document.getElementById('surah-grid').innerHTML = list.map(s => `
                <div class="surah-item" onclick="openVideo('${s.video_path}', false)">
                    <p style="color:#999; font-size:0.7rem; margin-bottom:5px;">Ø³ÙˆØ±Ø©</p>
                    ${s.title}
                </div>
            `).join('');
            
            const dayIdx = new Date().getDate() % (list.length || 1);
            if(list[dayIdx]) document.getElementById('ch-title').innerText = list[dayIdx].title;
        }

        function startChallenge() {
            const list = allSurahs.filter(s => s.grade === currentGrade && s.semester == currentSem);
            const dayIdx = new Date().getDate() % (list.length || 1);
            if(list[dayIdx]) openVideo(list[dayIdx].video_path, true);
        }

        function openVideo(path, chMode) {
            isChallenge = chMode; lastTime = 0;
            const v = document.getElementById('v-obj');
            v.src = path.includes('http') ? path : `https://ict.moe.gov.om/tlawti/video/${path}`;
            
            document.getElementById('player-modal').style.display = 'flex';
            document.getElementById('ch-hud').style.display = chMode ? 'block' : 'none';
            v.controls = !chMode;

            v.onseeking = () => {
                if(isChallenge && v.currentTime > lastTime + 1) {
                    v.currentTime = lastTime;
                    showToast();
                }
            };

            v.ontimeupdate = () => {
                if(v.currentTime > lastTime) lastTime = v.currentTime;
                const progress = Math.floor((v.currentTime / v.duration) * 100) || 0;
                if(isChallenge) {
                    document.getElementById('bar-inner').style.width = progress + '%';
                    document.getElementById('pct-label').innerText = progress + '%';
                    if(progress >= 75) {
                        localStorage.setItem('murooj_v2_' + new Date().toDateString(), 'won');
                        checkDailyStatus();
                    }
                }
            };
            v.play();
        }

        function checkDailyStatus() {
            if(localStorage.getItem('murooj_v2_' + new Date().toDateString())) {
                document.getElementById('ch-action-area').innerHTML = '<span style="color:var(--success); font-weight:bold; font-size:1.2rem;">ğŸ† Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆÙ…</span>';
            }
        }

        function closePlayer() { document.getElementById('v-obj').pause(); document.getElementById('player-modal').style.display = 'none'; }
        
        function showAbout() {
            alert("Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ Ø§Ù„Ø±ÙÙ‘Ù‚Ù…ÙÙŠ V2\n--------------------------\nÙ…Ù†ØµØ© Ø°ÙƒÙŠØ© Ù„Ø®Ø¯Ù…Ø© Ø·Ù„Ø§Ø¨ Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ÙˆØ¬\nØ¨Ø¥Ø´Ø±Ø§Ù Ø§Ù„Ø£Ø³ØªØ§Ø°: ÙÙŠØµÙ„ Ø§Ù„Ø¹Ø±ÙŠØ¨ÙŠ");
        }

        function showToast() {
            const t = document.getElementById('toast');
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        boot();
    </script>
</body>
</html>
