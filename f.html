<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ Ø§Ù„Ø±ÙÙ‘Ù‚Ù…ÙÙŠ | Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø±Ø³Ù…ÙŠØ©</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #041a11;
            --accent: #c4a04d;
            --accent-light: #e6cc8a;
            --bg-light: #fdfaf1;
            --success: #27ae60;
            --danger: #c0392b;
            --shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--primary); 
            font-family: 'Tajawal', sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column;
            overflow: hidden;
        }

        /* Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¹Ù„ÙˆÙŠ ÙˆØ§Ù„Ø³ÙÙ„ÙŠ */
        .official-bar { 
            background: #000; 
            color: var(--accent); 
            text-align: center; 
            padding: 6px; 
            font-size: 10px; 
            font-weight: bold; 
            border-bottom: 1px solid var(--accent);
            letter-spacing: 1px;
        }

        .main-header { 
            background: linear-gradient(135deg, #0b422a 0%, #041a11 100%); 
            padding: 12px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            box-shadow: var(--shadow);
            z-index: 100;
        }

        .logo-box { display: flex; align-items: center; gap: 12px; }
        .logo-img { width: 48px; height: 48px; border-radius: 50%; border: 2px solid var(--accent); background: #fff; }
        .app-name { font-family: 'Amiri', serif; color: var(--accent); font-size: 1.4rem; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙÙˆÙ (Ù…Ø·ÙˆØ± Ù„Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„ÙƒÙ…Ø¨ÙŠÙˆØªØ±) */
        .grades-scroller {
            background: #062b1b;
            padding: 10px;
            overflow-x: auto;
            display: flex;
            gap: 10px;
            border-bottom: 1px solid var(--accent);
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .grades-scroller::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */

        .grade-item {
            padding: 8px 18px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            border-radius: 25px;
            cursor: pointer;
            white-space: nowrap;
            font-size: 0.9rem;
            transition: 0.3s;
            border: 1px solid rgba(196,160,77,0.2);
        }
        .grade-item.active { background: var(--accent); color: var(--primary); font-weight: bold; border-color: #fff; }

        /* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†ØµØ© */
        .main-content { 
            flex: 1; 
            overflow-y: auto; 
            background: var(--bg-light); 
            padding: 20px;
            padding-bottom: 80px;
        }

        .semester-box {
            display: flex;
            background: #e0d8c3;
            padding: 4px;
            border-radius: 50px;
            margin-bottom: 20px;
            max-width: 350px;
            margin-left: auto; margin-right: auto;
        }
        .sem-btn {
            flex: 1; padding: 10px; border: none; border-radius: 50px;
            font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .sem-btn.active { background: var(--primary); color: var(--accent); }

        /* Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ…ÙŠ */
        .challenge-banner {
            background: #000; border: 2px solid var(--accent); border-radius: 15px;
            padding: 15px; margin-bottom: 20px; color: #fff;
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: var(--shadow);
        }
        .challenge-info h4 { color: var(--accent); font-size: 0.8rem; margin-bottom: 4px; }
        .challenge-info p { font-weight: 900; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø³ÙˆØ± */
        .surah-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 15px; 
        }
        .surah-card {
            background: #fff; border: 2px solid var(--accent); border-radius: 12px;
            padding: 20px 10px; text-align: center; cursor: pointer;
            transition: 0.2s; position: relative; font-weight: bold;
        }
        .surah-card:active { transform: scale(0.95); }
        .surah-card.done { border-color: var(--success); background: #f0fff4; }
        .done-icon { color: var(--success); margin-left: 5px; }

        /* Ù…Ø´ØºÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ù„Ø±Ù‚Ø§Ø¨Ø© */
        .video-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.98);
            z-index: 5000; display: none; align-items: center; justify-content: center;
            flex-direction: column; padding: 15px;
        }
        .video-wrapper { width: 100%; max-width: 700px; }
        video { width: 100%; border-radius: 10px; border: 2px solid var(--accent); }
        
        .status-msg { 
            margin-top: 10px; padding: 10px; border-radius: 5px; 
            font-weight: bold; display: none; text-align: center;
        }
        .msg-warning { background: var(--danger); color: #fff; }

        /* Ø²Ø± ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†ØµØ© */
        .btn-about {
            position: fixed; bottom: 70px; left: 20px;
            width: 55px; height: 55px; background: var(--accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 24px; color: #fff; border: 2px solid #fff;
            cursor: pointer; z-index: 400; box-shadow: var(--shadow);
        }

        footer.official-bar { position: fixed; bottom: 0; width: 100%; border-top: 1px solid var(--accent); }

        @media (min-width: 992px) {
            .grades-scroller { justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="official-bar">Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† | ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… | Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø±</div>

    <header class="main-header">
        <div class="logo-box">
            <img src="https://raw.githubusercontent.com/faissaltunisia/student-grades/main/Screenshot%202025-12-16%20235912.png" class="logo-img">
            <div>
                <p style="color: #fff; font-size: 0.7rem; opacity: 0.8;">Ù…Ø¯Ø±Ø³Ø©</p>
                <p style="color: var(--accent-light); font-weight: bold; font-size: 0.9rem;">Ø§Ù„Ù…Ø±ÙˆØ¬ Ù„Ù„ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
            </div>
        </div>
        <h1 class="app-name">Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬</h1>
    </header>

    <nav class="grades-scroller" id="grade-nav"></nav>

    <div class="btn-about" onclick="togglePopup('about-pop', true)">Û</div>

    <main class="main-content">
        <div class="semester-box">
            <button id="sem1" class="sem-btn active" onclick="changeSemester(1)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</button>
            <button id="sem2" class="sem-btn" onclick="changeSemester(2)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
        </div>

        <div class="challenge-banner">
            <div class="challenge-info">
                <h4>â­ ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… (Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø±Ù‚Ø§Ø¨ÙŠ)</h4>
                <p id="challenge-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</p>
            </div>
            <button onclick="launchChallenge()" id="play-challenge-btn" style="background:var(--accent); border:none; padding:8px 20px; border-radius:20px; font-weight:bold; cursor:pointer;">Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ø¯ÙŠ</button>
            <div id="challenge-status" style="display:none; color:var(--success); font-weight:bold;">ğŸ† ØªÙ… Ø§Ù„Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„ÙŠÙˆÙ…</div>
        </div>

        <div id="surah-grid" class="surah-grid"></div>
    </main>

    <div class="video-overlay" id="video-overlay">
        <div class="video-wrapper">
            <video id="main-video" controlsList="nodownload"></video>
            <div id="warning-box" class="status-msg msg-warning">âš ï¸ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ù…Ù†ÙˆØ¹! Ø§Ø³ØªÙ…Ø¹ Ù„ØªÙƒØ³Ø¨ Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ­Ø¯ÙŠ.</div>
            <button onclick="closeVideo()" style="width:100%; margin-top:20px; padding:12px; background:var(--accent); border:none; border-radius:8px; font-weight:bold; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø´ØºÙ„</button>
        </div>
    </div>

    <div class="video-overlay" id="about-pop">
        <div style="background:var(--primary); border:2px solid var(--accent); padding:30px; border-radius:15px; text-align:center; color:#fff; width:90%; max-width:400px;">
            <h2 style="color:var(--accent); margin-bottom:15px; font-family:'Amiri';">ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†ØµØ©</h2>
            <p style="line-height:1.8;">Ù…Ù†ØµØ© Ø±Ù‚Ù…ÙŠØ© Ù„Ø®Ø¯Ù…Ø© Ø·Ù„Ø§Ø¨ Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ÙˆØ¬ ÙÙŠ Ø­ÙØ¸ ÙˆØªÙ„Ø§ÙˆØ© Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ….<br><br>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°: <b>ÙÙŠØµÙ„ Ø§Ù„Ø¹Ø±ÙŠØ¨ÙŠ</b></p>
            <button onclick="togglePopup('about-pop', false)" style="margin-top:25px; padding:10px 40px; background:var(--accent); border:none; border-radius:20px; font-weight:bold;">Ø­Ø³Ù†Ø§Ù‹</button>
        </div>
    </div>

    <footer class="official-bar">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© - Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù…Ø±ÙˆØ¬ - Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø±</footer>

    <script>
        const SB_URL = 'https://vchzkeebmjqiohgoknnm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjaHprZWVibWpxaW9oZ29rbm5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzU3MjgsImV4cCI6MjA4MTcxMTcyOH0.bDIOdzhpj5M_5Hx7_SdnaBulImmFG41OKIOQGnx7FHI';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let surahs = [], currentGrade = "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", currentSem = 1;
        let completed = JSON.parse(localStorage.getItem('murooj_done')) || [];
        let isChallenge = false, lastPos = 0;

        async function init() {
            const { data } = await _sb.from('surahs').select('*');
            surahs = data || [];
            renderGrades();
            updateGrid();
            checkChallengeStatus();
        }

        function renderGrades() {
            const grades = ["Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†", "Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±"];
            const nav = document.getElementById('grade-nav');
            nav.innerHTML = grades.map(g => `
                <div class="grade-item ${g === currentGrade ? 'active' : ''}" onclick="selectGrade('${g}')">${g}</div>
            `).join('');
        }

        function selectGrade(g) { currentGrade = g; renderGrades(); updateGrid(); }
        function changeSemester(s) {
            currentSem = s;
            document.getElementById('sem1').className = s === 1 ? 'sem-btn active' : 'sem-btn';
            document.getElementById('sem2').className = s === 2 ? 'sem-btn active' : 'sem-btn';
            updateGrid();
        }

        function updateGrid() {
            const filtered = surahs.filter(s => s.grade === currentGrade && s.semester == currentSem);
            const grid = document.getElementById('surah-grid');
            grid.innerHTML = filtered.map(s => `
                <div class="surah-card ${completed.includes(s.id) ? 'done' : ''}" onclick="openVideo('${s.video_path}', '${s.id}', false)">
                    ${completed.includes(s.id) ? '<span class="done-icon">âœ…</span>' : ''}
                    ${s.title}
                </div>
            `).join('');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… Ù…Ù† Ø§Ù„Ù…Ù†Ù‡Ø¬ Ø§Ù„Ø­Ø§Ù„ÙŠ
            const dailyIdx = new Date().getDate() % (filtered.length || 1);
            if(filtered[dailyIdx]) document.getElementById('challenge-name').innerText = filtered[dailyIdx].title;
        }

        function checkChallengeStatus() {
            const today = new Date().toDateString();
            if(localStorage.getItem('murooj_day_' + today)) {
                document.getElementById('play-challenge-btn').style.display = 'none';
                document.getElementById('challenge-status').style.display = 'block';
            }
        }

        function launchChallenge() {
            const filtered = surahs.filter(s => s.grade === currentGrade && s.semester == currentSem);
            const dailyIdx = new Date().getDate() % (filtered.length || 1);
            const target = filtered[dailyIdx];
            if(target) openVideo(target.video_path, target.id, true);
        }

        function openVideo(path, id, challengeMode) {
            isChallenge = challengeMode;
            lastPos = 0;
            const video = document.getElementById('main-video');
            const overlay = document.getElementById('video-overlay');
            const warning = document.getElementById('warning-box');
            
            video.src = path.includes('http') ? path : `https://ict.moe.gov.om/tlawti/video/${path}`;
            overlay.style.display = 'flex';
            video.play();

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø±Ù‚Ø§Ø¨Ø© Ø§Ù„ØµØ§Ø±Ù…
            video.onseeking = () => {
                if(isChallenge && video.currentTime > lastPos + 1) {
                    video.currentTime = lastPos;
                    warning.style.display = 'block';
                    setTimeout(() => warning.style.display = 'none', 3000);
                }
            };

            video.ontimeupdate = () => {
                if (video.currentTime > lastPos) lastPos = video.currentTime;
                
                // Ø´Ø±Ø· Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ 75%
                if(video.duration > 0 && (video.currentTime / video.duration) >= 0.75) {
                    if(!completed.includes(id)) {
                        completed.push(id);
                        localStorage.setItem('murooj_done', JSON.stringify(completed));
                        updateGrid();
                    }
                    if(isChallenge) {
                        localStorage.setItem('murooj_day_' + new Date().toDateString(), 'true');
                        checkChallengeStatus();
                    }
                }
            };
        }

        function closeVideo() {
            const v = document.getElementById('main-video');
            v.pause(); v.src = "";
            document.getElementById('video-overlay').style.display = 'none';
        }

        function togglePopup(id, show) { document.getElementById(id).style.display = show ? 'flex' : 'none'; }

        init();
    </script>
</body>
</html>
