<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ Ø§Ù„Ø±ÙÙ‘Ù‚Ù…ÙÙŠ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@700&family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #041a11; --gold: #c4a04d; --gold-light: #e6cc8a; --white: #fdfaf1; --success: #2ecc71; --error: #e74c3c; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); font-family: 'Tajawal', sans-serif; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        .official-bar { background: #000; color: var(--gold); text-align: center; padding: 8px; font-size: 11px; font-weight: bold; border-bottom: 2px solid var(--gold); z-index: 1001; }
        footer.official-bar { border-bottom: none; border-top: 2px solid var(--gold); position: fixed; bottom: 0; width: 100%; }
        
        .main-header { background: linear-gradient(135deg, #0b422a 0%, #041a11 100%); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; }
        .logo-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--gold); background: #fff; }
        
        .main-layout { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 250px; background: #062b1b; border-left: 2px solid var(--gold); overflow-y: auto; padding: 15px; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ØµÙÙˆÙ Ù„Ù„Ù‡Ø§ØªÙ - Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
        .mobile-grades-nav { display: none; background: #062b1b; padding: 10px; overflow-x: auto; white-space: nowrap; border-bottom: 2px solid var(--gold); gap: 8px; }
        .grade-btn { display: inline-block; padding: 8px 15px; background: rgba(255,255,255,0.1); color: #fff; border-radius: 20px; font-size: 0.85rem; cursor: pointer; border: 1px solid transparent; }
        .grade-btn.active { background: var(--gold); color: #000; font-weight: bold; }

        .content { flex: 1; overflow-y: auto; background: var(--white); padding: 15px; padding-bottom: 100px; }

        .sem-toggle { display: flex; background: #e2dbc9; border-radius: 50px; margin-bottom: 15px; padding: 4px; border: 1px solid var(--gold); }
        .sem-toggle button { flex: 1; padding: 10px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; }
        .sem-toggle button.active { background: var(--bg); color: var(--gold); }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„ØªØ­Ø¯ÙŠ */
        .challenge-card { background: #000; border: 2px solid var(--gold); border-radius: 12px; padding: 15px; margin-bottom: 20px; color: #fff; display: flex; align-items: center; justify-content: space-between; }
        
        .surah-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .surah-item { position: relative; background: #fff; border: 2px solid var(--gold); border-radius: 12px; padding: 18px 8px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .surah-item.done { border-color: var(--success); background: #f0fff4; }

        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 4000; display: none; align-items: center; justify-content: center; flex-direction: column; padding: 15px; }
        .video-container { width: 100%; max-width: 600px; }
        video { width: 100%; border: 3px solid var(--gold); border-radius: 10px; }
        #anti-cheat-msg { color: var(--error); font-weight: bold; margin-top: 10px; background: #fff; padding: 5px 10px; border-radius: 5px; display: none; }

        .float-about { position: fixed; bottom: 60px; left: 15px; width: 50px; height: 50px; background: var(--gold); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; z-index: 2000; border: 2px solid #fff; cursor: pointer; }

        @media (max-width: 992px) { .sidebar { display: none; } .mobile-grades-nav { display: flex; } }
    </style>
</head>
<body>

    <div class="official-bar">Ø³Ù„Ø·Ù†Ø© Ø¹Ù…Ø§Ù† | ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… | Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø±</div>

    <header class="main-header">
        <img src="https://raw.githubusercontent.com/faissaltunisia/student-grades/main/Screenshot%202025-12-16%20235912.png" class="logo-img">
        <h1 style="color:var(--gold); font-family:'Amiri'; font-size: 1.3rem;">Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬</h1>
    </header>

    <nav class="mobile-grades-nav" id="m-grades"></nav>
    <div class="float-about" onclick="toggleAbout(true)">Û</div>

    <div class="main-layout">
        <aside class="sidebar" id="p-grades"></aside>
        <main class="content">
            <div class="sem-toggle">
                <button id="s1" class="active" onclick="setSem(1)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø£ÙˆÙ„</button>
                <button id="s2" onclick="setSem(2)">Ø§Ù„ÙØµÙ„ Ø§Ù„Ø«Ø§Ù†ÙŠ</button>
            </div>

            <div class="challenge-card">
                <div><small style="color:var(--gold)">â­ ØªØ­Ø¯ÙŠ Ø§Ù„ÙŠÙˆÙ… (Ù…Ø±Ø§Ù‚Ø¨)</small><p id="ch-title">...</p></div>
                <button id="ch-btn" onclick="startChallenge()" style="background:var(--gold); padding:8px 15px; border-radius:20px; font-weight:bold; border:none;">Ø§Ø¨Ø¯Ø£</button>
                <div id="ch-won" style="display:none; color:var(--success)">ğŸ† Ø¨Ø·Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
            </div>

            <div id="grid" class="surah-grid"></div>
        </main>
    </div>

    <div class="overlay" id="about-pop">
        <div style="background:var(--bg); border:3px solid var(--gold); padding:25px; border-radius:15px; text-align:center; color:#fff; width:90%; max-width:400px;">
            <h2 style="color:var(--gold); margin-bottom:15px;">ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ù†ØµØ©</h2>
            <p>Û Ù…ÙØµØ­ÙÙ Ø§Ù„Ù…ÙØ±ÙÙˆØ¬ Ø§Ù„Ø±ÙÙ‘Ù‚Ù…ÙÙŠ Û<br>Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ø³ØªØ§Ø°: ÙÙŠØµÙ„ Ø§Ù„Ø¹Ø±ÙŠØ¨ÙŠ</p>
            <button onclick="toggleAbout(false)" style="margin-top:20px; padding:10px 30px; background:var(--gold); border:none; border-radius:20px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <div class="overlay" id="player-layer">
        <div class="video-container">
            <video id="v-player" controls preload="metadata"></video>
            <div id="anti-cheat-msg">âš ï¸ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ù…Ù…Ù†ÙˆØ¹ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ!</div>
            <button onclick="closeVideo()" style="width:100%; margin-top:15px; padding:12px; background:var(--gold); border-radius:8px; font-weight:bold; border:none;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <footer class="official-bar">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ… - Ù…Ø­Ø§ÙØ¸Ø© Ø¸ÙØ§Ø±</footer>

    <script>
        const SB_URL = 'https://vchzkeebmjqiohgoknnm.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjaHprZWVibWpxaW9oZ29rbm5tIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzU3MjgsImV4cCI6MjA4MTcxMTcyOH0.bDIOdzhpj5M_5Hx7_SdnaBulImmFG41OKIOQGnx7FHI';
        const _sb = supabase.createClient(SB_URL, SB_KEY);

        let list = [], grade = "Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", sem = 1, maxT = 0, isChallengeMode = false;
        let completed = JSON.parse(localStorage.getItem('completed_surahs')) || [];

        async function init() {
            const { data } = await _sb.from('surahs').select('*');
            list = data || [];
            renderGrades();
            setupChallenge();
        }

        function renderGrades() {
            const gs = ["Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³", "Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¨Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù…Ù†", "Ø§Ù„ØµÙ Ø§Ù„ØªØ§Ø³Ø¹", "Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø­Ø§Ø¯ÙŠ Ø¹Ø´Ø±", "Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø¹Ø´Ø±"];
            const p = document.getElementById('p-grades'), m = document.getElementById('m-grades');
            const html = gs.map(g => `<div class="grade-btn ${g===grade?'active':''}" onclick="setGrade('${g}')">${g}</div>`).join('');
            p.innerHTML = html; m.innerHTML = html;
            renderGrid();
        }

        function setGrade(g) { grade = g; renderGrades(); }
        function setSem(s) { sem = s; document.getElementById('s1').className = s===1?'active':''; document.getElementById('s2').className = s===2?'active':''; renderGrid(); }

        function renderGrid() {
            const filtered = list.filter(i => i.grade === grade && i.semester == sem);
            document.getElementById('grid').innerHTML = filtered.map(i => `
                <div class="surah-item ${completed.includes(i.id)?'done':''}" onclick="playVideo('${i.video_path}', '${i.id}', false)">
                    ${completed.includes(i.id)?'âœ…':''} ${i.title}
                </div>
            `).join('');
        }

        function setupChallenge() {
            const ch = list[new Date().getDate() % list.length];
            if(!ch) return;
            document.getElementById('ch-title').innerText = ch.title;
            if(localStorage.getItem('won_'+new Date().toDateString())) {
                document.getElementById('ch-btn').style.display='none';
                document.getElementById('ch-won').style.display='block';
            }
        }

        function startChallenge() {
            const ch = list[new Date().getDate() % list.length];
            playVideo(ch.video_path, ch.id, true);
        }

        function playVideo(path, id, challenge) {
            isChallengeMode = challenge; maxT = 0;
            const v = document.getElementById('v-player');
            const url = path.includes('http') ? path : `https://ict.moe.gov.om/tlawti/video/${path}`;
            v.src = url;
            document.getElementById('player-layer').style.display = 'flex';
            
            // ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠ: Ù†Ù…Ù†Ø¹ Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
            v.ontimeupdate = () => {
                if(isChallengeMode) {
                    if(v.currentTime > maxT + 1.5) {
                        v.currentTime = maxT;
                        document.getElementById('anti-cheat-msg').style.display = 'block';
                        setTimeout(()=>document.getElementById('anti-cheat-msg').style.display='none', 2000);
                    } else { maxT = Math.max(maxT, v.currentTime); }
                    
                    // Ø´Ø±Ø· 75% Ù„Ù„ÙÙˆØ² Ø¨Ø§Ù„ØªØ­Ø¯ÙŠ
                    if((v.currentTime / v.duration) >= 0.75) {
                        localStorage.setItem('won_'+new Date().toDateString(), 'true');
                        setupChallenge();
                    }
                }
                
                // ÙÙŠ ÙƒÙ„ØªØ§ Ø§Ù„Ø­Ø§Ù„ØªÙŠÙ†ØŒ Ø¥Ø°Ø§ Ø´Ø§Ù‡Ø¯ 75% Ù†Ø­ØªØ³Ø¨ Ø§Ù„Ø³ÙˆØ±Ø© ÙƒØ¥Ù†Ø¬Ø§Ø²
                if((v.currentTime / v.duration) >= 0.75 && !completed.includes(id)) {
                    completed.push(id);
                    localStorage.setItem('completed_surahs', JSON.stringify(completed));
                    renderGrid();
                }
            };
            v.play();
        }

        function closeVideo() { const v = document.getElementById('v-player'); v.pause(); v.src=""; document.getElementById('player-layer').style.display='none'; }
        function toggleAbout(s) { document.getElementById('about-pop').style.display = s?'flex':'none'; }
        init();
    </script>
</body>
</html>
